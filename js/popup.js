colors = {};
colors.red50 = '#ffebee';
colors.red100 = '#ffcdd2';
colors.red200 = '#ef9a9a';
colors.red300 = '#e57373';
colors.red400 = '#ef5350';
colors.red500 = '#f44336';
colors.red600 = '#e53935';
colors.red700 = '#d32f2f';
colors.red800 = '#c62828';
colors.red900 = '#b71c1c';
colors.redA100 = '#ff8a80';
colors.redA200 = '#ff5252';
colors.redA400 = '#ff1744';
colors.redA700 = '#d50000';
colors.pink50 = '#fce4ec';
colors.pink100 = '#f8bbd0';
colors.pink200 = '#f48fb1';
colors.pink300 = '#f06292';
colors.pink400 = '#ec407a';
colors.pink500 = '#e91e63';
colors.pink600 = '#d81b60';
colors.pink700 = '#c2185b';
colors.pink800 = '#ad1457';
colors.pink900 = '#880e4f';
colors.pinkA100 = '#ff80ab';
colors.pinkA200 = '#ff4081';
colors.pinkA400 = '#f50057';
colors.pinkA700 = '#c51162';
colors.purple50 = '#f3e5f5';
colors.purple100 = '#e1bee7';
colors.purple200 = '#ce93d8';
colors.purple300 = '#ba68c8';
colors.purple400 = '#ab47bc';
colors.purple500 = '#9c27b0';
colors.purple600 = '#8e24aa';
colors.purple700 = '#7b1fa2';
colors.purple800 = '#6a1b9a';
colors.purple900 = '#4a148c';
colors.purpleA100 = '#ea80fc';
colors.purpleA200 = '#e040fb';
colors.purpleA400 = '#d500f9';
colors.purpleA700 = '#aa00ff';
colors.deeppurple50 = '#ede7f6';
colors.deeppurple100 = '#d1c4e9';
colors.deeppurple200 = '#b39ddb';
colors.deeppurple300 = '#9575cd';
colors.deeppurple400 = '#7e57c2';
colors.deeppurple500 = '#673ab7';
colors.deeppurple600 = '#5e35b1';
colors.deeppurple700 = '#512da8';
colors.deeppurple800 = '#4527a0';
colors.deeppurple900 = '#311b92';
colors.deeppurpleA100 = '#b388ff';
colors.deeppurpleA200 = '#7c4dff';
colors.deeppurpleA400 = '#651fff';
colors.deeppurpleA700 = '#6200ea';
colors.indigo50 = '#e8eaf6';
colors.indigo100 = '#c5cae9';
colors.indigo200 = '#9fa8da';
colors.indigo300 = '#7986cb';
colors.indigo400 = '#5c6bc0';
colors.indigo500 = '#3f51b5';
colors.indigo600 = '#3949ab';
colors.indigo700 = '#303f9f';
colors.indigo800 = '#283593';
colors.indigo900 = '#1a237e';
colors.indigoA100 = '#8c9eff';
colors.indigoA200 = '#536dfe';
colors.indigoA400 = '#3d5afe';
colors.indigoA700 = '#304ffe';
colors.blue50 = '#e3f2fd';
colors.blue100 = '#bbdefb';
colors.blue200 = '#90caf9';
colors.blue300 = '#64b5f6';
colors.blue400 = '#42a5f5';
colors.blue500 = '#2196f3';
colors.blue600 = '#1e88e5';
colors.blue700 = '#1976d2';
colors.blue800 = '#1565c0';
colors.blue900 = '#0d47a1';
colors.blueA100 = '#82b1ff';
colors.blueA200 = '#448aff';
colors.blueA400 = '#2979ff';
colors.blueA700 = '#2962ff';
colors.lightblue50 = '#e1f5fe';
colors.lightblue100 = '#b3e5fc';
colors.lightblue200 = '#81d4fa';
colors.lightblue300 = '#4fc3f7';
colors.lightblue400 = '#29b6f6';
colors.lightblue500 = '#03a9f4';
colors.lightblue600 = '#039be5';
colors.lightblue700 = '#0288d1';
colors.lightblue800 = '#0277bd';
colors.lightblue900 = '#01579b';
colors.lightblueA100 = '#80d8ff';
colors.lightblueA200 = '#40c4ff';
colors.lightblueA400 = '#00b0ff';
colors.lightblueA700 = '#0091ea';
colors.cyan50 = '#e0f7fa';
colors.cyan100 = '#b2ebf2';
colors.cyan200 = '#80deea';
colors.cyan300 = '#4dd0e1';
colors.cyan400 = '#26c6da';
colors.cyan500 = '#00bcd4';
colors.cyan600 = '#00acc1';
colors.cyan700 = '#0097a7';
colors.cyan800 = '#00838f';
colors.cyan900 = '#006064';
colors.cyanA100 = '#84ffff';
colors.cyanA200 = '#18ffff';
colors.cyanA400 = '#00e5ff';
colors.cyanA700 = '#00b8d4';
colors.teal50 = '#e0f2f1';
colors.teal100 = '#b2dfdb';
colors.teal200 = '#80cbc4';
colors.teal300 = '#4db6ac';
colors.teal400 = '#26a69a';
colors.teal500 = '#009688';
colors.teal600 = '#00897b';
colors.teal700 = '#00796b';
colors.teal800 = '#00695c';
colors.teal900 = '#004d40';
colors.tealA100 = '#a7ffeb';
colors.tealA200 = '#64ffda';
colors.tealA400 = '#1de9b6';
colors.tealA700 = '#00bfa5';
colors.green50 = '#e8f5e9';
colors.green100 = '#c8e6c9';
colors.green200 = '#a5d6a7';
colors.green300 = '#81c784';
colors.green400 = '#66bb6a';
colors.green500 = '#4caf50';
colors.green600 = '#43a047';
colors.green700 = '#388e3c';
colors.green800 = '#2e7d32';
colors.green900 = '#1b5e20';
colors.greenA100 = '#b9f6ca';
colors.greenA200 = '#69f0ae';
colors.greenA400 = '#00e676';
colors.greenA700 = '#00c853';
colors.lightgreen50 = '#f1f8e9';
colors.lightgreen100 = '#dcedc8';
colors.lightgreen200 = '#c5e1a5';
colors.lightgreen300 = '#aed581';
colors.lightgreen400 = '#9ccc65';
colors.lightgreen500 = '#8bc34a';
colors.lightgreen600 = '#7cb342';
colors.lightgreen700 = '#689f38';
colors.lightgreen800 = '#558b2f';
colors.lightgreen900 = '#33691e';
colors.lightgreenA100 = '#ccff90';
colors.lightgreenA200 = '#b2ff59';
colors.lightgreenA400 = '#76ff03';
colors.lightgreenA700 = '#64dd17';
colors.lime50 = '#f9fbe7';
colors.lime100 = '#f0f4c3';
colors.lime200 = '#e6ee9c';
colors.lime300 = '#dce775';
colors.lime400 = '#d4e157';
colors.lime500 = '#cddc39';
colors.lime600 = '#c0ca33';
colors.lime700 = '#afb42b';
colors.lime800 = '#9e9d24';
colors.lime900 = '#827717';
colors.limeA100 = '#f4ff81';
colors.limeA200 = '#eeff41';
colors.limeA400 = '#c6ff00';
colors.limeA700 = '#aeea00';
colors.yellow50 = '#fffde7';
colors.yellow100 = '#fff9c4';
colors.yellow200 = '#fff59d';
colors.yellow300 = '#fff176';
colors.yellow400 = '#ffee58';
colors.yellow500 = '#ffeb3b';
colors.yellow600 = '#fdd835';
colors.yellow700 = '#fbc02d';
colors.yellow800 = '#f9a825';
colors.yellow900 = '#f57f17';
colors.yellowA100 = '#ffff8d';
colors.yellowA200 = '#ffff00';
colors.yellowA400 = '#ffea00';
colors.yellowA700 = '#ffd600';
colors.amber50 = '#fff8e1';
colors.amber100 = '#ffecb3';
colors.amber200 = '#ffe082';
colors.amber300 = '#ffd54f';
colors.amber400 = '#ffca28';
colors.amber500 = '#ffc107';
colors.amber600 = '#ffb300';
colors.amber700 = '#ffa000';
colors.amber800 = '#ff8f00';
colors.amber900 = '#ff6f00';
colors.amberA100 = '#ffe57f';
colors.amberA200 = '#ffd740';
colors.amberA400 = '#ffc400';
colors.amberA700 = '#ffab00';
colors.orange50 = '#fff3e0';
colors.orange100 = '#ffe0b2';
colors.orange200 = '#ffcc80';
colors.orange300 = '#ffb74d';
colors.orange400 = '#ffa726';
colors.orange500 = '#ff9800';
colors.orange600 = '#fb8c00';
colors.orange700 = '#f57c00';
colors.orange800 = '#ef6c00';
colors.orange900 = '#e65100';
colors.orangeA100 = '#ffd180';
colors.orangeA200 = '#ffab40';
colors.orangeA400 = '#ff9100';
colors.orangeA700 = '#ff6d00';
colors.deeporange50 = '#fbe9e7';
colors.deeporange100 = '#ffccbc';
colors.deeporange200 = '#ffab91';
colors.deeporange300 = '#ff8a65';
colors.deeporange400 = '#ff7043';
colors.deeporange500 = '#ff5722';
colors.deeporange600 = '#f4511e';
colors.deeporange700 = '#e64a19';
colors.deeporange800 = '#d84315';
colors.deeporange900 = '#bf360c';
colors.deeporangeA100 = '#ff9e80';
colors.deeporangeA200 = '#ff6e40';
colors.deeporangeA400 = '#ff3d00';
colors.deeporangeA700 = '#dd2c00';
colors.brown50 = '#efebe9';
colors.brown100 = '#d7ccc8';
colors.brown200 = '#bcaaa4';
colors.brown300 = '#a1887f';
colors.brown400 = '#8d6e63';
colors.brown500 = '#795548';
colors.brown600 = '#6d4c41';
colors.brown700 = '#5d4037';
colors.brown800 = '#4e342e';
colors.brown900 = '#3e2723';
colors.bluegrey50 = '#eceff1';
colors.bluegrey100 = '#cfd8dc';
colors.bluegrey200 = '#b0bec5';
colors.bluegrey300 = '#90a4ae';
colors.bluegrey400 = '#78909c';
colors.bluegrey500 = '#607d8b';
colors.bluegrey600 = '#546e7a';
colors.bluegrey700 = '#455a64';
colors.bluegrey800 = '#37474f';
colors.bluegrey900 = '#263238';
colors.grey50 = '#fafafa';
colors.grey100 = '#f5f5f5';
colors.grey200 = '#eeeeee';
colors.grey300 = '#e0e0e0';
colors.grey400 = '#bdbdbd';
colors.grey500 = '#9e9e9e';
colors.grey600 = '#757575';
colors.grey700 = '#616161';
colors.grey800 = '#424242';
colors.grey900 = '#212121';
colors.black = '#000000';
colors.white = '#ffffff';
colors.transparent = 'rgba(0, 0, 0, 0)';
colors.fullBlack = 'rgba(0, 0, 0, 1)';
colors.darkBlack = 'rgba(0, 0, 0, 0.87)';
colors.lightBlack = 'rgba(0, 0, 0, 0.54)';
colors.minBlack = 'rgba(0, 0, 0, 0.26)';
colors.faintBlack = 'rgba(0, 0, 0, 0.12)';
colors.fullWhite = 'rgba(255, 255, 255, 1)';
colors.darkWhite = 'rgba(255, 255, 255, 0.87)';
colors.lightWhite = 'rgba(255, 255, 255, 0.54)';

console.log(colors);

var emailAddress = null;

// setTimeout(function() {
//     chrome.browserAction.setIcon({
//         path: {
//             16:    '../img/alt-icon16.png',
//             32:    '../img/alt-icon32.png',
//             128:   '../img/alt-icon128.png'            
//         }
//     });
// }, 5000);

/**
 * check if user has provide the email address 
 * and it exists in local storage
 */
var emailExists = function() {
    var email = localStorage.getItem('userEmailAddress');
    if (email !== undefined && email != null && email != '') {
        emailAddress = email;
        return true;
    }
    //don't need to have email saved to be logged in

    var apiUrl = "https://"+loggedIn[0]+".complinks.co/api/v1/getUserDetail";

    $.post(apiUrl, {})
    .done(function(data) {
        console.log(data);
        return true;//save email from userDetail call
    })
    .fail(function(data) {
        $('#no-email-alert').show();
        $('.image-2').attr('src','images/icon128.png');
        $('.navbar-brand-co').html('Complinks Rewards Everywhere');
        // put default data in popup
        return false;        
    });


};

/**
 * Show email field in popup if the user   
 * didn't provided it yet otherwise hide it.  
 */
var toggleEmailField = function() {
    if (!emailExists()) {
        $('.loading-icon').hide();
        $('.email-address-div').show();
    } else {
        $('.email-address-div').hide();
    }
};

var openSettings = function() {
    chrome.tabs.create({
        'url': 'chrome://extensions/?options=' + chrome.runtime.id
    });
};
var extractHostname = function(url) {
    var hostname;
    if (url.indexOf("://") > -1) {
        hostname = url.split('/')[2];
    } else {
        hostname = url.split('/')[0];
    }
    hostname = hostname.split(':')[0];
    hostname = hostname.split('?')[0];
    hostname = hostname.replace('www.', '');
    return hostname;
}

var showOffer = function(data) {
    if (!data.isAdvertiser || data.reward == '') {
        return;
    }
    var html = '<div class="row">';
    html += '<div class="col-xs-12">';
    html += '<buttons class="btn btn-primary activate-btn">Activate ' + data.reward + '</buttons>';
    html += '</div></div>';
    $('.show-offers').html(html);
    $('.activate-btn').click(function() {
        chrome.tabs.query({
            active: true,
            currentWindow: true
        }, function(tabs) {
            chrome.tabs.sendMessage(tabs[0].id, {
                type: "create-activate-tab",
                url: data.clickUrl
            }, function(response) {});
        });
    });
};

/**
 * Send POST request to get offers
 */
var getOffers = function() {
    var currentDomain = '';
    var apiUrl = "https://"+loggedIn[0]+".complinks.co/api/v1/checkDomain";
    var email = localStorage.getItem('userEmailAddress');
    chrome.tabs.query({
        active: true,
        currentWindow: true
    }, function(tabs) {
        if (!tabs || !tabs[0] || !tabs[0].url) {
            return;
        }
        currentDomain = extractHostname(tabs[0].url);
        $.post(apiUrl, {
                "domainName": currentDomain
            })
            .done(function(data) {
                showOffer(data);
                // console.log(data.availablePointBal);
                $('.avail-points').html(data.availablePointBal+' Points');
                localStorage.setItem('availablePoints', data.availablePointBal);

                // console.log(data);
            })
            .fail(function(data) {
                callbacks.error(data);
            });
    });
};

/**
 * Close popup window
 */
var cancel = function() {
    window.close();
}

/**
 * Bind onclick events on buttons
 */
var bindEvents = function() {
    $('#cancel').click(cancel);
    $('#settings').click(openSettings);
};

/**
 * Create html to show on extension popup
 */
var buildTimelineHtml = function(events) {
    var html = '';
    if (events.length < 1) {
        html += '<div class="well well-sm">Nothing to show</div>';
        return html;
    }
    $.each(events, function(index, value) {
        if (value && value != '') {
            html += '<div class="well well-sm">' + value + '</div>';
        }
    });
    return html;
};

/**
 * Build html to show error if 
 * API call fails to fetch News
 * For specific email
 */
var getNewsErrorHtml = function() {
    var html = '<div class="alert alert-danger">';
    html += 'Api failed to fetch events for this email</div>';
    return html;
};

/**
 * Get timeline of user activities
 */
var getEvents = function() {
    // if (!emailAddress)
        // return true;
    // console.log(loggedIn);
    $(".loading-icon").show();
    var apiUrl = "https://"+loggedIn[0]+".complinks.co/api/v1/getNews";
    $.post(apiUrl, {
            userEmail: emailAddress,
        })
        .done(function(data) {
            // workaround until api doesn't always return 200
            if(data['status'] === 'unauthorized') {
                $(".loading-icon").hide();
                $('.timeline-events').html(getNewsErrorHtml());    
                return false;
            }
            // console.log("Events loaded ", data);
            $(".loading-icon").hide();
            if (data) {
                var eventHtml = buildTimelineHtml(data);
                // console.log("eventHtml", eventHtml);
                $('.timeline-events').html(eventHtml);
            }
        })
        .fail(function() {
            $(".loading-icon").hide();
            $('.timeline-events').html(getNewsErrorHtml());
        });
};

var initSubdomain = function() {
    var domains = ['shop','xclub'];
    var loggedIn = [];
    domains.forEach(function(domain) {
        var apiUrl = "https://"+domain+".complinks.co/api/v1/getUserDetail";
  
        $.post(apiUrl, {})
        .done(function(data) {
            if(typeof data.status !== "unauthorized" && typeof data.partnerSubdomain !== "undefined" ) {
                loggedIn.push(data.partnerSubdomain);
                userDetail.push(data);
            }

        });
    });
    return loggedIn;
}

var buildTheme = function() {
    console.log(userDetail[0].partnerStyle);

    var partnerStyle = JSON.parse(userDetail[0].partnerStyle);
    var primaryName = partnerStyle.primary.name.replace('-','').toLowerCase();
    var primaryHex = primaryName.concat(partnerStyle.primary.main);
    var accentName = partnerStyle.accent.name.replace('-','').toLowerCase();
    var accentHex = accentName.concat(partnerStyle.accent.main);
    
    $('.navbar-header-co').css({'background-color':colors[primaryHex]});

    setTimeout(function() {
        $('.well-sm').css({'background-color':colors[primaryHex]});
        $('.activate-btn').css({'background-color':colors[accentHex]});
        $('.activate-btn').css({'border-color':colors[accentHex]});

        $(".activate-btn").hover(function () {
           $(this).animate({'opacity':'0.7'}, 100);
        },function (){
           $(this).animate({'opacity':'1'}, 100);
        });
    },200)
    

    console.log(colors[primaryHex]);

    $('.image-2').attr('src',userDetail[0].partnerIcon); //change class in webflow
    //else { Complinks Rewards Everywhere}   images/icon128.png
    $('.navbar-brand-co').html(userDetail[0].partnerName);

}


var loggedIn;
var userDetail = [];
$(document).ready(function() {
    loggedIn = initSubdomain();
    setTimeout(function() {
        console.log(loggedIn);
        bindEvents();
        toggleEmailField();
        getEvents();
        getOffers();
        buildTheme();
    }, 300);
});