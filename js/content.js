colors = {};colors.red50 = '#ffebee';colors.red100 = '#ffcdd2';colors.red200 = '#ef9a9a';colors.red300 = '#e57373';colors.red400 = '#ef5350';colors.red500 = '#f44336';colors.red600 = '#e53935';colors.red700 = '#d32f2f';colors.red800 = '#c62828';colors.red900 = '#b71c1c';colors.redA100 = '#ff8a80';colors.redA200 = '#ff5252';colors.redA400 = '#ff1744';colors.redA700 = '#d50000';colors.pink50 = '#fce4ec';colors.pink100 = '#f8bbd0';colors.pink200 = '#f48fb1';colors.pink300 = '#f06292';colors.pink400 = '#ec407a';colors.pink500 = '#e91e63';colors.pink600 = '#d81b60';colors.pink700 = '#c2185b';colors.pink800 = '#ad1457';colors.pink900 = '#880e4f';colors.pinkA100 = '#ff80ab';colors.pinkA200 = '#ff4081';colors.pinkA400 = '#f50057';colors.pinkA700 = '#c51162';colors.purple50 = '#f3e5f5';colors.purple100 = '#e1bee7';colors.purple200 = '#ce93d8';colors.purple300 = '#ba68c8';colors.purple400 = '#ab47bc';colors.purple500 = '#9c27b0';colors.purple600 = '#8e24aa';colors.purple700 = '#7b1fa2';colors.purple800 = '#6a1b9a';colors.purple900 = '#4a148c';colors.purpleA100 = '#ea80fc';colors.purpleA200 = '#e040fb';colors.purpleA400 = '#d500f9';colors.purpleA700 = '#aa00ff';colors.deeppurple50 = '#ede7f6';colors.deeppurple100 = '#d1c4e9';colors.deeppurple200 = '#b39ddb';colors.deeppurple300 = '#9575cd';colors.deeppurple400 = '#7e57c2';colors.deeppurple500 = '#673ab7';colors.deeppurple600 = '#5e35b1';colors.deeppurple700 = '#512da8';colors.deeppurple800 = '#4527a0';colors.deeppurple900 = '#311b92';colors.deeppurpleA100 = '#b388ff';colors.deeppurpleA200 = '#7c4dff';colors.deeppurpleA400 = '#651fff';colors.deeppurpleA700 = '#6200ea';colors.indigo50 = '#e8eaf6';colors.indigo100 = '#c5cae9';colors.indigo200 = '#9fa8da';colors.indigo300 = '#7986cb';colors.indigo400 = '#5c6bc0';colors.indigo500 = '#3f51b5';colors.indigo600 = '#3949ab';colors.indigo700 = '#303f9f';colors.indigo800 = '#283593';colors.indigo900 = '#1a237e';colors.indigoA100 = '#8c9eff';colors.indigoA200 = '#536dfe';colors.indigoA400 = '#3d5afe';colors.indigoA700 = '#304ffe';colors.blue50 = '#e3f2fd';colors.blue100 = '#bbdefb';colors.blue200 = '#90caf9';colors.blue300 = '#64b5f6';colors.blue400 = '#42a5f5';colors.blue500 = '#2196f3';colors.blue600 = '#1e88e5';colors.blue700 = '#1976d2';colors.blue800 = '#1565c0';colors.blue900 = '#0d47a1';colors.blueA100 = '#82b1ff';colors.blueA200 = '#448aff';colors.blueA400 = '#2979ff';colors.blueA700 = '#2962ff';colors.lightblue50 = '#e1f5fe';colors.lightblue100 = '#b3e5fc';colors.lightblue200 = '#81d4fa';colors.lightblue300 = '#4fc3f7';colors.lightblue400 = '#29b6f6';colors.lightblue500 = '#03a9f4';colors.lightblue600 = '#039be5';colors.lightblue700 = '#0288d1';colors.lightblue800 = '#0277bd';colors.lightblue900 = '#01579b';colors.lightblueA100 = '#80d8ff';colors.lightblueA200 = '#40c4ff';colors.lightblueA400 = '#00b0ff';colors.lightblueA700 = '#0091ea';colors.cyan50 = '#e0f7fa';colors.cyan100 = '#b2ebf2';colors.cyan200 = '#80deea';colors.cyan300 = '#4dd0e1';colors.cyan400 = '#26c6da';colors.cyan500 = '#00bcd4';colors.cyan600 = '#00acc1';colors.cyan700 = '#0097a7';colors.cyan800 = '#00838f';colors.cyan900 = '#006064';colors.cyanA100 = '#84ffff';colors.cyanA200 = '#18ffff';colors.cyanA400 = '#00e5ff';colors.cyanA700 = '#00b8d4';colors.teal50 = '#e0f2f1';colors.teal100 = '#b2dfdb';colors.teal200 = '#80cbc4';colors.teal300 = '#4db6ac';colors.teal400 = '#26a69a';colors.teal500 = '#009688';colors.teal600 = '#00897b';colors.teal700 = '#00796b';colors.teal800 = '#00695c';colors.teal900 = '#004d40';colors.tealA100 = '#a7ffeb';colors.tealA200 = '#64ffda';colors.tealA400 = '#1de9b6';colors.tealA700 = '#00bfa5';colors.green50 = '#e8f5e9';colors.green100 = '#c8e6c9';colors.green200 = '#a5d6a7';colors.green300 = '#81c784';colors.green400 = '#66bb6a';colors.green500 = '#4caf50';colors.green600 = '#43a047';colors.green700 = '#388e3c';colors.green800 = '#2e7d32';colors.green900 = '#1b5e20';colors.greenA100 = '#b9f6ca';colors.greenA200 = '#69f0ae';colors.greenA400 = '#00e676';colors.greenA700 = '#00c853';colors.lightgreen50 = '#f1f8e9';colors.lightgreen100 = '#dcedc8';colors.lightgreen200 = '#c5e1a5';colors.lightgreen300 = '#aed581';colors.lightgreen400 = '#9ccc65';colors.lightgreen500 = '#8bc34a';colors.lightgreen600 = '#7cb342';colors.lightgreen700 = '#689f38';colors.lightgreen800 = '#558b2f';colors.lightgreen900 = '#33691e';colors.lightgreenA100 = '#ccff90';colors.lightgreenA200 = '#b2ff59';colors.lightgreenA400 = '#76ff03';colors.lightgreenA700 = '#64dd17';colors.lime50 = '#f9fbe7';colors.lime100 = '#f0f4c3';colors.lime200 = '#e6ee9c';colors.lime300 = '#dce775';colors.lime400 = '#d4e157';colors.lime500 = '#cddc39';colors.lime600 = '#c0ca33';colors.lime700 = '#afb42b';colors.lime800 = '#9e9d24';colors.lime900 = '#827717';colors.limeA100 = '#f4ff81';colors.limeA200 = '#eeff41';colors.limeA400 = '#c6ff00';colors.limeA700 = '#aeea00';colors.yellow50 = '#fffde7';colors.yellow100 = '#fff9c4';colors.yellow200 = '#fff59d';colors.yellow300 = '#fff176';colors.yellow400 = '#ffee58';colors.yellow500 = '#ffeb3b';colors.yellow600 = '#fdd835';colors.yellow700 = '#fbc02d';colors.yellow800 = '#f9a825';colors.yellow900 = '#f57f17';colors.yellowA100 = '#ffff8d';colors.yellowA200 = '#ffff00';colors.yellowA400 = '#ffea00';colors.yellowA700 = '#ffd600';colors.amber50 = '#fff8e1';colors.amber100 = '#ffecb3';colors.amber200 = '#ffe082';colors.amber300 = '#ffd54f';colors.amber400 = '#ffca28';colors.amber500 = '#ffc107';colors.amber600 = '#ffb300';colors.amber700 = '#ffa000';colors.amber800 = '#ff8f00';colors.amber900 = '#ff6f00';colors.amberA100 = '#ffe57f';colors.amberA200 = '#ffd740';colors.amberA400 = '#ffc400';colors.amberA700 = '#ffab00';colors.orange50 = '#fff3e0';colors.orange100 = '#ffe0b2';colors.orange200 = '#ffcc80';colors.orange300 = '#ffb74d';colors.orange400 = '#ffa726';colors.orange500 = '#ff9800';colors.orange600 = '#fb8c00';colors.orange700 = '#f57c00';colors.orange800 = '#ef6c00';colors.orange900 = '#e65100';colors.orangeA100 = '#ffd180';colors.orangeA200 = '#ffab40';colors.orangeA400 = '#ff9100';colors.orangeA700 = '#ff6d00';colors.deeporange50 = '#fbe9e7';colors.deeporange100 = '#ffccbc';colors.deeporange200 = '#ffab91';colors.deeporange300 = '#ff8a65';colors.deeporange400 = '#ff7043';colors.deeporange500 = '#ff5722';colors.deeporange600 = '#f4511e';colors.deeporange700 = '#e64a19';colors.deeporange800 = '#d84315';colors.deeporange900 = '#bf360c';colors.deeporangeA100 = '#ff9e80';colors.deeporangeA200 = '#ff6e40';colors.deeporangeA400 = '#ff3d00';colors.deeporangeA700 = '#dd2c00';colors.brown50 = '#efebe9';colors.brown100 = '#d7ccc8';colors.brown200 = '#bcaaa4';colors.brown300 = '#a1887f';colors.brown400 = '#8d6e63';colors.brown500 = '#795548';colors.brown600 = '#6d4c41';colors.brown700 = '#5d4037';colors.brown800 = '#4e342e';colors.brown900 = '#3e2723';colors.bluegrey50 = '#eceff1';colors.bluegrey100 = '#cfd8dc';colors.bluegrey200 = '#b0bec5';colors.bluegrey300 = '#90a4ae';colors.bluegrey400 = '#78909c';colors.bluegrey500 = '#607d8b';colors.bluegrey600 = '#546e7a';colors.bluegrey700 = '#455a64';colors.bluegrey800 = '#37474f';colors.bluegrey900 = '#263238';colors.grey50 = '#fafafa';colors.grey100 = '#f5f5f5';colors.grey200 = '#eeeeee';colors.grey300 = '#e0e0e0';colors.grey400 = '#bdbdbd';colors.grey500 = '#9e9e9e';colors.grey600 = '#757575';colors.grey700 = '#616161';colors.grey800 = '#424242';colors.grey900 = '#212121';colors.black = '#000000';colors.white = '#ffffff';colors.transparent = 'rgba(0, 0, 0, 0)';colors.fullBlack = 'rgba(0, 0, 0, 1)';colors.darkBlack = 'rgba(0, 0, 0, 0.87)';colors.lightBlack = 'rgba(0, 0, 0, 0.54)';colors.minBlack = 'rgba(0, 0, 0, 0.26)';colors.faintBlack = 'rgba(0, 0, 0, 0.12)';colors.fullWhite = 'rgba(255, 255, 255, 1)';colors.darkWhite = 'rgba(255, 255, 255, 0.87)';colors.lightWhite = 'rgba(255, 255, 255, 0.54)';
/**
 * Create html to show popup on bottom of page
 * Please see its css in content.css file
 */
var buildPopup = function(data, userDataResponse) {
    var partnerStyle = JSON.parse(userDataResponse.partnerStyle);
    var primaryName = partnerStyle.primary.name.replace('-','').toLowerCase();
    var primaryHex = primaryName.concat(partnerStyle.primary.main);
    var accentName = partnerStyle.accent.name.replace('-','').toLowerCase();
    var accentHex = accentName.concat(partnerStyle.accent.main);

    var html = '';
    if (data.isAdvertiser && data.extensionEnabled) {
        html += '<div class="complinks_popup">';
        html += '<div class="complinks_partner_logo" style="background-color: '+colors[primaryHex]+'; border-color: '+colors[primaryHex]+';"><span class="helper"></span>';
        if(window.location.host.includes('berries.com')) {
            html += '<img style="height: 80px !important;" class="complinks_logo" src="'+userDataResponse.partnerLogo+'" />';
        } else {
            html += '<img class="complinks_logo" src="'+userDataResponse.partnerLogo+'" />';    
        }
        html += '</div>';
        html += '<div class="complinks_main_content" style="border-color: '+colors[primaryHex]+';"><span class="helper"></span>';
        var p = userDataResponse.partnerName;
        if(p === "Foxwoods") {
            if(window.location.host.includes('godaddy.com') || window.location.host.includes('walgreens.com') ) {
                html += '<buttons class="complinks_activate_button" style="min-width: 250px; padding: 16px 14px; font-size: 14px !important; padding-top: 16px; color: #000; background-color: '+colors[accentHex]+';" >Click to earn ' + data.reward + '</buttons>';
            } else {
                html += '<buttons class="complinks_activate_button" style="min-width: 241px; padding: 16px 20px; font-size: 14px !important; color: #000; background-color: '+colors[accentHex]+';" >Click to earn ' + data.reward + '</buttons>';
            }
        } else {
            if(window.location.host.includes('godaddy.com') || window.location.host.includes('walgreens.com') ) {
                html += '<buttons class="complinks_activate_button" style="min-width: 250px; padding: 16px 14px; font-size: 14px !important; padding-top: 16px; background-color: '+colors[accentHex]+';" >Click to earn ' + data.reward + '</buttons>';
            } else {
                html += '<buttons class="complinks_activate_button" style="min-width: 241px; padding: 16px 20px; font-size: 14px !important; background-color: '+colors[accentHex]+';" >Click to earn ' + data.reward + '</buttons>';
            }
        }
        html += '<span class="complinks_dismiss_container">';
        html += '<a href="#" class="complinks_dismiss_button">Ã—</a>';
        html += '</span>';
        html += '</div>';
        html += '</div>';
    }

    return html;
};

$(document).on('click','.complinks_dismiss_button',function(e) {
    sessionStorage.setItem('ebatesCloneShowPopup', 'show'); 
    sessionStorage.setItem('ebatesCloneShowPopupDismissed', 'show'); 
})
/**
 * Handle activate button click
 */
var bindActivateEvent = function(data) {
    $('.complinks_activate_button').click(function() {
        $(".complinks_activate_button").css({
            'background-color': 'green'
        });         
        sessionStorage.setItem('ebatesCloneShowPopup', 'show');
        var date = new Date;
        var time = date.getTime();
        sessionStorage.setItem('cl_activated_stamp', time);
        if (data && data.clickUrl) {
            window.location.href = data.clickUrl;
        }
    });
};


/**
 * Handle activate later button click
 */
var bindActivateLaterEvent = function() {
    $('.complinks_dismiss_button').click(function() {
        sessionStorage.setItem('ebatesCloneShowPopup', 'show');
        $('.complinks_popup').hide();
    });
};

/**
 * show popup after getting data from API
 */
var handleSuccess = function(data, userDataResponse) {
    // Dont show popup to user if user has already  
    // activated or dismissed the offer earlier
    // console.log(userDataResponse);
    // set activated cookie and timestamp, don't show if passed 1 hour
    if(data.isAdvertiser && data.extensionEnabled) {
        var show = sessionStorage.getItem('ebatesCloneShowPopup');
        var activated = sessionStorage.getItem('ebatesCloneShowPopupActivated');
        var dismissed = sessionStorage.getItem('ebatesCloneShowPopupDismissed'); 

        if (show == 'show' && activated !== 'show') { //1st time activated and not dismissed, make green
            console.log('a');
            var date = new Date;
            var time = date.getTime();
            var oldStamp = Number(sessionStorage.getItem('cl_activated_stamp'));
            var diff = Math.abs(time - new Date(oldStamp)); //1 hr = 3600000
            if(diff < 3600000) { //show activated if not x'ed
                if(dismissed !== 'show') {
                    console.log('1');
                    $('body').prepend(buildPopup(data, userDataResponse));
                    $(".complinks_popup").show("slow", function() {
                        bindActivateEvent(data);
                        bindActivateLaterEvent();
                    });    
                    $('.complinks_activate_button').html(data.reward+" Activated!");
                    $(".complinks_activate_button").css({
                        'background-color': 'green'
                    });       
                    $(".complinks_popup").fadeTo(2000, 500).slideUp(500, function() {
                        $(".complinks_popup").slideUp(2000);
                    }); 
                    if(dismissed !== 'show') {    
                        sessionStorage.setItem('ebatesCloneShowPopupActivated', 'show');
                    }
                } else {
                    console.log('less than 1 hr and x\'ed out');
                }
            } else if (dismissed === "show") {
                console.log('2-4');
            } else { // timeout, activate again
                console.log('2');
                console.log('complinks timeout');
                $('body').prepend(buildPopup(data, userDataResponse));
                $(".complinks_popup").show("slow", function() {
                    bindActivateEvent(data);
                    bindActivateLaterEvent();
                });    
            }
            // show activated flag and check
            // return true;
        } else if(show == "show" && activated == "show") { 
            if(diff > 3600000) { //build again
                console.log('3');
                console.log('complinks timeout');
                $('body').prepend(buildPopup(data, userDataResponse));
                $(".complinks_popup").show("slow", function() {
                    bindActivateEvent(data);
                    bindActivateLaterEvent();
                });  
            }
        } else if(dismissed === "show") {
            console.log('4');
        } else {
            console.log('5');
            $('body').prepend(buildPopup(data, userDataResponse));
            $(".complinks_popup").show("slow", function() {
                bindActivateEvent(data);
                bindActivateLaterEvent();
            });
        }
    }
};

/**
 * show popup after getting data from API
 */
var handleGoogleSuccess = function(data, userData, element) {
    if(data.isAdvertiser && data.extensionEnabled) {
        $(element).before("<div style=\"margin-bottom: 0px;\"><img class=\"searchResultDeal\" style=\"height: 25px; display: inline-block; margin-bottom:-5px;\" src=\""+userData.searchResultLogoUrl+"\"></img>"+"<a class=\"btn btn-primary activate-btn google-activate\" href=\""+$(element).attr('href')+"\"style=\"margin-bottom: 5px !important; margin-left: 15px; padding: 10px 15px; background-color:#FF3D02; border-color: #FF3D02; border-radius: 0px !important; border-width: 2px; color: #ffffff; display: inline-block; margin-bottom: 0; font-weight: normal; text-align: center; vertical-align: middle; -ms-touch-action: manipulation; touch-action: manipulation; cursor: pointer; background-image: none; white-space: nowrap; padding: 10px 15px; font-size: 12px; line-height: 1;\">Click to earn " + data.reward + "</a></div>");
    }
};

// $(document).on('click', function() {
//     chrome.runtime.sendMessage({
//         type: "set-activated-from-google"
//     }, function(response) {
//         //catch elsewhere
//     });          
// });

/**
 * handle if error occurs in API call
 */
var handleError = function(data, userDataResponse) {
    console.log("API call failed", data);
};

var callbacks = {
    success: handleSuccess,
    error: handleError
};

/**
 * Get user email address from local storage
 */
var getEmailAddress = function() {
    chrome.runtime.sendMessage({
        type: "get-user-email"
    }, function(response) {
        if (response && response.email) {
            subdomain = response.partnerSubdomain;
            //message to bg to save localstorage
            makeRequest(response, callbacks);   
            chrome.runtime.sendMessage({
                type: "save-user-data",
                data: response
            }, function(response) {
                
            });                 
        } else { //logged out, ask for email, look for cookie?
            console.log(response);
        }
    });
};


/**
 * Send POST request to get
 */
var makeGoogleRequest = function(userDataResponse, callbacks, res, elems) {
    var partnerStyle = JSON.parse(userDataResponse.partnerStyle);
    var primaryName = partnerStyle.primary.name.replace('-','').toLowerCase();
    var primaryHex = primaryName.concat(partnerStyle.primary.main);
    var accentName = partnerStyle.accent.name.replace('-','').toLowerCase();
    var accentHex = accentName.concat(partnerStyle.accent.main);

    console.log(colors[accentHex]);
    var apiUrl = "https://"+userDataResponse.partnerSubdomain+".complinks.co/api/v1/checkDomain";
    console.log(res);
    var res2 = res.map(function(item) {
        var a = item.replace('http://', '').replace('https://', '');
        return a.substring(0, a.indexOf('/'));
    });
    var set = [...new Set(res2)];
    $.post({
        url: apiUrl,
        type: "POST",
        data: JSON.stringify({"domainName":set}),
        contentType:"application/json",
        dataType:"json"
    })
    .done(function(data) {
        console.log(data);
        console.log(elems);
        console.log(set);
        Object.keys(res2).forEach(function(key, index) { //for each in long list
            //find position in set to check if valid
            var idx = set.findIndex(function(item) {
                return item === res2[key];
            });
            if(data[idx].isAdvertiser && data[idx].extensionEnabled) {
                var buttonHTML = "";
                var p = userDataResponse.partnerName;
                if(p === "Foxwoods") {
                    buttonHTML = "<div style=\"margin-bottom: 0px;\"><img class=\"searchResultDeal\" style=\"height: 25px; display: inline-block; margin-bottom:-5px;\" src=\""+userDataResponse.searchResultLogoUrl+"\"></img>"+"<a class=\"btn btn-primary activate-btn google-activate\" href=\""+elems[index].getAttribute('href')+"\"style=\"margin-bottom: 5px !important; margin-left: 15px; padding: 10px 15px; background-color:"+colors[accentHex]+"; border-color: #FF3D02; border-radius: 0px !important; border-width: 2px; color: "+colors[primaryHex]+"; display: inline-block; margin-bottom: 0; font-weight: normal; text-align: center; vertical-align: middle; -ms-touch-action: manipulation; touch-action: manipulation; cursor: pointer; background-image: none; white-space: nowrap; padding: 10px 15px; font-size: 12px; line-height: 1;\">Click to earn " + data[idx].reward + "</a></div>";
                } else {
                    buttonHTML = "<div style=\"margin-bottom: 0px;\"><img class=\"searchResultDeal\" style=\"height: 25px; display: inline-block; margin-bottom:-5px;\" src=\""+userDataResponse.searchResultLogoUrl+"\"></img>"+"<a class=\"btn btn-primary activate-btn google-activate\" href=\""+elems[index].getAttribute('href')+"\"style=\"margin-bottom: 5px !important; margin-left: 15px; padding: 10px 15px; background-color:"+colors[accentHex]+"; border-color: #FF3D02; border-radius: 0px !important; border-width: 2px; color: #ffffff; display: inline-block; margin-bottom: 0; font-weight: normal; text-align: center; vertical-align: middle; -ms-touch-action: manipulation; touch-action: manipulation; cursor: pointer; background-image: none; white-space: nowrap; padding: 10px 15px; font-size: 12px; line-height: 1;\">Click to earn " + data[idx].reward + "</a></div>";
                }
                $(elems[index]).before(buttonHTML);
            }
        });
    })
    .fail(function(data) {
        console.log(data);
        Object.keys(data).forEach(function(key, index) {
            callbacks.error(data[index], userDataResponse);
        });
    });
}


function getLocation(href) {
    var match = href.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)([\/]{0,1}[^?#]*)(\?[^#]*|)(#.*|)$/);
    return match && {
        href: href,
        protocol: match[1],
        host: match[2],
        hostname: match[3],
        port: match[4],
        pathname: match[5],
        search: match[6],
        hash: match[7]
    }
}

/**
 * Send POST request to get
 */
var makeRequest = function(userDataResponse, callbacks, domain, element) {
    if(domain!==null && typeof domain !== 'undefined') {
        console.log(domain);
        var a = domain.replace('http://', '').replace('https://', '');
        currentDomain = a.substring(0, a.indexOf('/'));
    } else {
        console.log(getLocation(window.location.href).hostname);
        var currentDomain = window.location.host.replace('www.', '');    
    }
    var arr = [currentDomain];
    console.log(JSON.stringify({"domainName":arr}));
    var apiUrl = "https://"+subdomain+".complinks.co/api/v1/checkDomain";
    $.post({
        url: apiUrl,
        type: "POST",
        data: JSON.stringify({"domainName":arr}),
        contentType:"application/json",
        dataType:"json"
    })
    .done(function(data) {
        console.log(data[0]);
        callbacks.success(data[0], userDataResponse, element);
    })
    .fail(function(data) {
        console.log(data[0]);
        callbacks.error(data[0], userDataResponse);
    });
}
function getAllUrlParams() {
    var match,
        pl     = /\+/g,  // Regex for replacing addition symbol with a space
        search = /([^&=]+)=?([^&]*)/g,
        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
        query  = window.location.search.substring(1);

    var urlParams = {};
    while (match = search.exec(query))
       urlParams[decode(match[1])] = decode(match[2]);
    return urlParams;
};

var subdomain;
$(function() {
    var whost = window.location.host;
    $(document).on('click','a',function(e) {
        var href = $(this).attr('href');
        var urlFull = getAllUrlParams(href);
        var urlParams = Object.keys(urlFull);
        chrome.runtime.sendMessage({
            type: "check-params",
            data: urlFull,
            host: whost,
            mode: 'click',
            href: href,
            referrer: ""
        }, function () {   });
    });    
    var href = window.location.href;
    var urlFull = getAllUrlParams(href);
    var urlParams = Object.keys(urlFull);
    console.log(href);
    console.log(urlFull);
    console.log(urlParams);    
    chrome.runtime.sendMessage({
        type: "check-params",
        data: urlFull,
        host: window.location.host,
        mode: 'refresh',
        href: window.location.href,
        referrer: document.referrer
    }, function (response) { 
        if(response !== undefined && response.msg === "cease") {
            console.log('ceased');
            sessionStorage.setItem('ebatesCloneShowPopupDismissed', 'show');  
        }
    });
    // chrome.runtime.sendMessage({
    //     type: "path-check",
    //     data: href
    // }, function (response) { 
    //     console.log('path-check destination');
    //     console.log(response);
    //     if(!window.location.host.includes("complinks.co") && response.msg === "trip-activated") {
            // var date = new Date;
            // var time = date.getTime();
            // sessionStorage.setItem('cl_activated_stamp', time);
            // sessionStorage.setItem('ebatesCloneShowPopup', 'show');
    //         sessionStorage.setItem('ebatesCloneShowPopupActivated', 'show');        
    //         sessionStorage.setItem('ebatesCloneShowPopupDismissed', 'show');  
    //     }
    // });    

    // getEmailAddress();  
    callbacks['success'] = handleGoogleSuccess;//overwrite google page callback here
    var elems = document.querySelectorAll('.g .r > a:not(.l)');
    console.log(elems.length);
    if(elems.length > 0) {
        console.log('1');
        var res = Array.from(elems).map(function(el) {
            console.log(el);
            return el.getAttribute('href');
        });
        chrome.runtime.sendMessage({
                type: "get-user-email"
            }, function(response2) {
                console.log('got response from get-user-email');
                console.log(response2);
                if (response2 && response2.email) {
                    subdomain = response2.partnerSubdomain;                     
                    makeGoogleRequest(response2, callbacks, res, elems);  
                    chrome.runtime.sendMessage({
                        type: "save-user-data",
                        data: response2
                    }, function(response3) {});                 
                } else {
                    console.log('logged out');
                }
        });
    } else if(!window.location.host.includes('google.com')) {
        console.log('2');
        //set cease from redirect page or cease if in previous link
        console.log('2.a');
        chrome.runtime.sendMessage({
            type: "cease-check",
            host: window.location.host
        }, function(response) {
            console.log(response.msg);
            if(response.msg === "cease") {
                sessionStorage.setItem('ebatesCloneShowPopupDismissed', 'show');  
            } else if (response.msg === "activated") {
                var date = new Date;
                var time = date.getTime();
                sessionStorage.setItem('cl_activated_stamp', time);
                sessionStorage.setItem('ebatesCloneShowPopup', 'show');                
                // sessionStorage.setItem('ebatesCloneShowPopupDismissed', 'show');  
                // sessionStorage.setItem('ebatesCloneShowPopupActivated', 'show');   
                callbacks['success'] = handleSuccess;
                // getEmailAddress();
            } else {
                callbacks['success'] = handleSuccess;
                // getEmailAddress();
            }
        });

        // makeRequest(callbacks);
        chrome.runtime.onMessage.addListener(
            function(request, sender, sendResponse) {
                if (request.type == 'create-activate-tab') {
                    console.log(request);
                    var date = new Date;
                    var time = date.getTime();
                    sessionStorage.setItem('cl_activated_stamp', time);
                    sessionStorage.setItem('ebatesCloneShowPopup', 'show');
                    if(request.mode === "popup-activate") {
                        sessionStorage.setItem('ebatesCloneShowPopupActivated', 'show');
                    }
                    if (request && request.url) {
                        window.location.href = request.url;
                    }
                    sendResponse({
                        type: "activated"
                    });
                } else if (request.type == 'activated?') {
                    sendResponse({
                        type: sessionStorage.getItem('ebatesCloneShowPopupActivated')
                    });
                }
            });        
    }
});